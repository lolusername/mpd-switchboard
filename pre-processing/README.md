# Pre-Processing Module

The **Pre-Processing** module is an essential component of our PDF management system. It encompasses various scripts and tools designed to prepare PDF documents for subsequent processing tasks such as OCR (Optical Character Recognition) and redaction. This module ensures that all PDFs are standardized, searchable, and free of sensitive information before they proceed to downstream applications.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Available Makefile Commands](#available-makefile-commands)
  - [Check Environment](#check-environment)
  - [Setup Environment](#setup-environment)
  - [PDF Size Analysis](#pdf-size-analysis)
  - [OCR Check](#ocr-check)
  - [Run OCR](#run-ocr)
    - [Standard OCR](#standard-ocr)
    - [In-Place OCR](#in-place-ocr)
  - [Redact PDFs](#redact-pdfs)
    - [Dry-Run Redaction](#dry-run-redaction)
    - [Actual Redaction](#actual-redaction)
  - [Clean Environment](#clean-environment)
  - [Install Dependencies](#install-dependencies)
- [Workflow Overview](#workflow-overview)
- [Logging and Reports](#logging-and-reports)
- [Troubleshooting](#troubleshooting)
- [Additional Information](#additional-information)

## Prerequisites

Before diving into the pre-processing tasks, ensure that your system meets the following prerequisites:

- **Python 3.7+**: The scripts are written in Python and require Python version 3.7 or higher.
- **Poetry**: A dependency management and packaging tool for Python. [Install Poetry](https://python-poetry.org/docs/#installation).
- **pyenv** (Optional but recommended): Helps manage multiple Python versions. [Install pyenv](https://github.com/pyenv/pyenv#installation).
- **Make**: A build automation tool used to execute Makefile commands. Most Unix-like systems come with Make pre-installed.


## Available Makefile Commands

The Makefile orchestrates various pre-processing tasks. Below are the available commands along with detailed explanations and usage examples.

### Check Environment

**Command**: `make check`

**Description**: Verifies that `pyenv` and `poetry` are installed on your system.

**Usage**:

   ```bash
   make install
   ```

**Outcome**: 
- Runs `poetry install` to install all dependencies.
- Outputs a confirmation message upon successful installation.

## Workflow Overview

1. **Setup the Environment**: Initialize the Python environment with all necessary dependencies.

   ```bash
   make setup
   ```

2. **Analyze PDF Sizes**: Assess the sizes of all PDFs to identify any that may require special handling.

   ```bash
   make size-check
   ```

3. **Check for Selectable Text**: Determine which PDFs contain selectable text and which require OCR.

   ```bash
   make ocr-check
   ```

4. **Perform OCR**: Convert non-selectable PDFs into searchable text. Choose between standard OCR or in-place OCR based on your needs.

   - **Standard OCR**:

     ```bash
     make ocr
     ```

   - **In-Place OCR**:

     ```bash
     make ocr INPLACE=true
     ```

5. **Redact Sensitive Information**: Remove or obscure sensitive data from PDFs. Start with a dry run to verify the redaction process.

   - **Dry-Run Redaction**:

     ```bash
     make redact MODE=dry-run
     ```

   - **Actual Redaction**:

     ```bash
     make redact
     ```

6. **Cleanup**: Remove the virtual environment and temporary files when they are no longer needed.

   ```bash
   make clean
   ```

## Logging and Reports

- **Sensitive Data Logs**: After running redaction (dry-run or actual), logs are stored in `./reports/sensitive_data_log.txt`. These logs provide details on the sensitive items detected and redacted.

- **PDF Size Analysis Reports**: Results from the PDF size analysis are saved in the `./reports` directory as generated by `doc-size-analysis.py`.

- **OCR Metadata**: The `ocr-check.py` script generates a `meta_data.json` file in the `./reports` directory, listing PDFs that require OCR.

## Troubleshooting

- **Poetry Not Installed**: If you encounter an error related to Poetry not being installed, ensure that you've followed the [Poetry installation guide](https://python-poetry.org/docs/#installation) and that it's added to your system's PATH.

- **Python Version Issues**: Verify that you're using Python 3.7 or higher. You can check your Python version with:

  ```bash
  python --version
  ```

- **Missing Dependencies**: If a script fails due to missing packages, try reinstalling dependencies:

  ```bash
  make install
  ```

- **Permission Errors**: Ensure that you have the necessary read/write permissions for the `./data` and `./reports` directories.

- **Log Files Not Found**: If log files are missing after running a command, ensure that the `./reports` directory exists and that the scripts have successfully executed. You can manually create the directory if needed:

  ```bash
  mkdir -p ./reports
  ```

## Additional Information

- **Extending Functionality**: The pre-processing module is designed to be extensible. You can add new scripts or modify existing ones to handle additional preprocessing tasks as required.

- **Customizing Makefile Variables**: If your input or output directories differ from the defaults (`./data` and `./reports`), you can override them by setting environment variables when running Make commands. For example:

  ```bash
  make size-check INPUT_FOLDER=./new_data OUTPUT_DIR=./new_reports
  ```

- **Parallel Processing**: The redaction script utilizes multiprocessing to handle multiple PDFs simultaneously, leveraging all available CPU cores for efficiency.

- **SpaCy Model**: The `redact.py` script uses SpaCy's `en_core_web_sm` model for Named Entity Recognition (NER). If not already installed, the script will automatically download it. Ensure you have an active internet connection during the first run.

- **Error Handling**: All scripts include robust error handling and logging to facilitate easy debugging and maintenance.

---

For further assistance or to contribute to the project, please contact [your-email@example.com] or open an issue on the repository.
