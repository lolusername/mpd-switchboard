version: '3'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.2
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms384m -Xmx384m"
      - path.repo=/usr/share/elasticsearch/snapshots
      - cluster.routing.allocation.disk.threshold_enabled=false
      - "bootstrap.memory_lock=false"
      - cluster.routing.allocation.disk.watermark.low=95%
      - cluster.routing.allocation.disk.watermark.high=98%
      - cluster.routing.allocation.disk.watermark.flood_stage=99%
    ulimits:
      memlock:
        soft: -1
        hard: -1
    expose:
      - "9200"
    volumes:
      - switchboard_data:/usr/share/elasticsearch/data
      - ./snapshots:/usr/share/elasticsearch/snapshots
    networks:
      - switchboard_default

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: switchboard_api
    expose:
      - "8000"
    volumes:
      - ../data:/app/pdf_data
      - ./api:/app
    environment:
      - PDF_DIRECTORY=/app/pdf_data
      - ELASTICSEARCH_HOST=http://elasticsearch:9200
      - SECRET_KEY=${SECRET_KEY}
      - PYTHONPATH=/app
    depends_on:
      - elasticsearch
    networks:
      - switchboard_default
    restart: always

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: switchboard_frontend
    expose:
      - "3000"
    environment:
      - HOST=0.0.0.0
      - PORT=3000
      - NUXT_PUBLIC_API_BASE=https://switchboard.miski.studio/api
    depends_on:
      - api
    networks:
      - switchboard_default

  nginx:
    image: nginx:alpine
    container_name: switchboard_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/switchboard.conf:/etc/nginx/conf.d/switchboard.conf:ro
      - /etc/letsencrypt/live/switchboard.miski.studio/fullchain.pem:/etc/ssl/certs/selfsigned.crt:ro
      - /etc/letsencrypt/live/switchboard.miski.studio/privkey.pem:/etc/ssl/private/selfsigned.key:ro
    depends_on:
      - frontend
      - api
    networks:
      - switchboard_default

volumes:
  switchboard_data:

networks:
  switchboard_default:
    driver: bridge

